<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì´ë¬´ ë§¤ì¶œ ê´€ë¦¬</title>
</head>
<body>
  <h1>ğŸ’µ ì´ë¬´ - ë§¤ì¶œ ê´€ë¦¬</h1>

  <table border="1" cellpadding="10" cellspacing="0">
    <thead>
      <tr>
        <th>í…Œì´ë¸” ë²ˆí˜¸</th>
        <th>ì£¼ë¬¸ ì´ì•¡</th>
        <th>ìƒì„¸ë³´ê¸°</th>
      </tr>
    </thead>
    <tbody id="table-body">
      <!-- ì—¬ê¸° ì£¼ë¬¸ í…Œì´ë¸” ëª©ë¡ ë“¤ì–´ì˜´ -->
    </tbody>
    <tfoot>
      <tr>
        <td><strong>ì´ í•©ê³„</strong></td>
        <td id="total-sales"><strong>â‚©0</strong></td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, onSnapshot, getDocs, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      // ğŸ”¥ ì—¬ê¸°ì— Firebase ì„¤ì • ë„£ì„ ê²ƒ
      apiKey: "AIzaSyB5fNlZwwqhutBm-iGGR4SX3HPUY6PR1cU",
    authDomain: "fjocs-57418.firebaseapp.com",
    projectId: "fjocs-57418",
    storageBucket: "fjocs-57418.firebasestorage.app",
    messagingSenderId: "1025344233506",
    appId: "1:1025344233506:web:edcf50e049f8b4ce18aa7b",
    measurementId: "G-059R0SJRLJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadAccounting() {
      const ordersRef = collection(db, "orders");
      const snapshot = await getDocs(ordersRef);

      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      let totalSales = 0;

      const docs = [];
      snapshot.forEach(docSnap => {
        docs.push({ id: docSnap.id, ...docSnap.data() });
      });

      // í…Œì´ë¸” ë²ˆí˜¸ìˆœ ì •ë ¬
      docs.sort((a, b) => a.tableNumber - b.tableNumber);

      for (const order of docs) {
        const totalPrice = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        totalSales += totalPrice;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.tableNumber}ë²ˆ</td>
          <td>â‚©${totalPrice.toLocaleString()}</td>
          <td><button onclick="toggleDetail('${order.id}')">ìƒì„¸ë³´ê¸°</button></td>
          <td>
  <button onclick="toggleDetail('${order.id}')">ìƒì„¸ë³´ê¸°</button>
  <button onclick="resetTable(${order.tableNumber})">ë¦¬ì…‹</button>
</td>

        `;

        tbody.appendChild(tr);

        // ìƒì„¸ë³´ê¸°ìš© ìˆ¨ê²¨ì§„ í–‰
        const detailTr = document.createElement('tr');
        detailTr.id = `detail-${order.id}`;
        detailTr.style.display = 'none'; // ê¸°ë³¸ ìˆ¨ê¹€
        detailTr.innerHTML = `
          <td colspan="3">
            <ul>
              ${order.items.map(item => `<li>${item.menu} (${item.quantity}ê°œ) - â‚©${(item.price * item.quantity).toLocaleString()}</li>`).join('')}
            </ul>
          </td>
        `;

        tbody.appendChild(detailTr);
      }

      document.getElementById('total-sales').innerHTML = `<strong>â‚©${totalSales.toLocaleString()}</strong>`;
    }

    window.toggleDetail = (id) => {
      const detailRow = document.getElementById(`detail-${id}`);
      if (detailRow.style.display === 'none') {
        detailRow.style.display = '';
      } else {
        detailRow.style.display = 'none';
      }
    };

    loadAccounting();

    window.resetTable = async (tableNumber) => {
  if (confirm(`${tableNumber}ë²ˆ í…Œì´ë¸” ì£¼ë¬¸ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    await fetch(`/reset-table/${tableNumber}`, { method: 'POST' });
    alert('ì •ì‚° ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
  }
};

  </script>

</body>
</html>
